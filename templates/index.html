<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crecimiento Espiritual-Emocional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .chat-container { max-width: 768px; height: 95vh; display: flex; flex-direction: column; margin: auto; }
        .message { padding: 1rem; border-radius: 1rem; margin-bottom: 0.5rem; max-width: 80%; word-wrap: break-word; }
        .user-message { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .ai-message { background-color: #ffffff; color: #374151; align-self: flex-start; border-bottom-left-radius: 0.25rem; position: relative; }
        .audio-icon { cursor: pointer; margin-left: 0.5rem; width: 1.25rem; height: 1.25rem; display: inline-block; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center p-4 sm:p-6">

<div class="chat-container bg-white shadow-xl rounded-2xl overflow-hidden flex flex-col w-full">
    <header class="bg-indigo-600 text-white p-4 text-center text-xl font-semibold rounded-t-2xl">
        Crecimiento Espiritual-Emocional
    </header>

    <div id="messages-container" class="flex-grow p-4 overflow-y-auto space-y-4"></div>

    <div class="p-4 bg-gray-100 flex items-center rounded-b-2xl">
        <input type="text" id="user-input" placeholder="Escribe tu mensaje..."
               class="flex-grow p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200 shadow-sm">
        <button id="send-button"
                class="ml-2 bg-indigo-600 text-white p-3 rounded-xl transition-all duration-200 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.917H17.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.917a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z" />
            </svg>
        </button>
    </div>
</div>

<script>
const chatInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const messagesContainer = document.getElementById('messages-container');

function addMessage(text, sender, audioData = null) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    
    if (sender === 'user') {
        messageDiv.classList.add('user-message', 'self-end');
        messageDiv.textContent = text;
    } else {
        messageDiv.classList.add('ai-message', 'self-start', 'border', 'border-gray-200');
        messageDiv.textContent = text;

        if (audioData) {
            const audioIcon = document.createElement('span');
            audioIcon.classList.add('audio-icon');
            audioIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block text-gray-500 ml-2">
                                      <path d="M13.5 4.5a1.5 1.5 0 0 0-1.5 1.5v1.895A4.5 4.5 0 0 0 12 14.25h1.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5ZM1.5 6a1.5 1.5 0 0 1 1.5-1.5h1.5a1.5 1.5 0 0 1 1.5 1.5v5.895a4.5 4.5 0 0 1 1.5 2.555V18a1.5 1.5 0 0 0 3 0v-1.105a4.5 4.5 0 0 1 1.5-2.555V6a1.5 1.5 0 0 0-1.5-1.5H9a1.5 1.5 0 0 0-1.5 1.5v2.25a.75.75 0 0 1-1.5 0V6Zm10.5-1.5a1.5 1.5 0 0 0 1.5-1.5V1.5a1.5 1.5 0 0 0-3 0v1.5a1.5 1.5 0 0 0 1.5 1.5Z" />
                                  </svg>`;
            audioIcon.onclick = () => {
                const audio = new Audio(`data:audio/mp3;base64,${audioData}`);
                audio.play();
            };
            messageDiv.appendChild(audioIcon);
        }
    }
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function sendMessage() {
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;

    addMessage(userMessage, 'user');
    chatInput.value = '';

    const loadingMessage = document.createElement('div');
    loadingMessage.classList.add('message', 'ai-message', 'italic', 'text-gray-500');
    loadingMessage.textContent = 'Escribiendo...';
    messagesContainer.appendChild(loadingMessage);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    try {
        const response = await fetch('/chat', {  // URL relativa
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        messagesContainer.removeChild(loadingMessage);
        addMessage(data.reply, 'ai', data.audio);
    } catch (error) {
        console.error('Error:', error);
        messagesContainer.removeChild(loadingMessage);
        addMessage('Hubo un error al procesar tu solicitud.', 'ai');
    }
}

sendButton.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') sendMessage();
});

window.onload = () => {
     addMessage('¡Hola! Soy tu guía espiritual y emocional. ¿En qué puedo ayudarte hoy?', 'ai', null);
};
</script>
</body>
</html>
