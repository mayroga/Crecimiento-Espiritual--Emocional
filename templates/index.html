<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crecimiento Espiritual-Emocional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin:0; padding:0; }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            max-width: 768px;
            margin: auto;
        }

        /* Sección de pagos */
        .payment-section {
            background-color: #f3f4f6;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .payment-button {
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 0.75rem;
            color: white;
            border: none;
            font-weight: 500;
        }

        .donate-btn { background-color: #16a34a; }   /* Verde */
        .service-btn { background-color: #2563eb; }  /* Azul */

        .payment-section input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #d1d5db;
            font-size: 1rem;
        }

        /* Chat */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #messages-container {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .message {
            padding: 1rem;
            border-radius: 1rem;
            max-width: 90%;
            word-wrap: break-word;
            font-size: 1rem;
        }

        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-message {
            background-color: #ffffff;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
            position: relative;
        }

        .audio-icon {
            cursor: pointer;
            margin-left: 0.5rem;
            width: 1.5rem;
            height: 1.5rem;
            display: inline-block;
        }

        .chat-input-section {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            padding: 0.5rem;
        }

        .chat-input-section input {
            flex: 1;
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #d1d5db;
        }

        .chat-input-section button {
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 0.75rem;
            background-color: #3b82f6;
            color: white;
            border: none;
        }

        @media (max-width: 500px) {
            .container { height: 100vh; width: 100vw; border-radius: 0; }
            .chat-input-section { flex-direction: column; }
            .chat-input-section input, .chat-input-section button { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Sección de pagos siempre visible -->
        <div class="payment-section">
            <input type="number" id="donation-amount" placeholder="Monto donación USD" min="4.99" step="0.01">
            <button id="donate-button" class="payment-button donate-btn">Aporta lo que quieras</button>
            <button id="service-button" class="payment-button service-btn">Paga tu servicio ($10.00)</button>
        </div>

        <!-- Chat scrollable -->
        <div class="chat-container">
            <header class="bg-indigo-600 text-white p-4 text-center text-xl font-semibold rounded-t-2xl">
                Crecimiento Espiritual-Emocional
            </header>

            <div id="messages-container"></div>

            <div class="chat-input-section">
                <input type="text" id="user-input" placeholder="Escribe tu mensaje...">
                <button id="send-button">Enviar</button>
            </div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe("{{ stripe_pub_key }}");

        function addMessage(text, sender, audioData = null) {
            const messagesContainer = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            if (audioData) {
                const audio = new Audio(`data:audio/mp3;base64,${audioData}`);
                const audioIcon = document.createElement('span');
                audioIcon.classList.add('audio-icon');
                audioIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block text-gray-500 ml-2">
                                            <path d="M13.5 4.5a1.5 1.5 0 0 0-1.5 1.5V18a1.5 1.5 0 0 0 3 0V6a1.5 1.5 0 0 0-1.5-1.5ZM6 4.5a1.5 1.5 0 0 0-1.5 1.5V18a1.5 1.5 0 0 0 3 0V6a1.5 1.5 0 0 0-1.5-1.5Z" />
                                        </svg>`;
                messageDiv.appendChild(audioIcon);
                audioIcon.addEventListener('click', () => audio.play());
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const msg = input.value.trim();
            if (msg === '') return;

            addMessage(msg, 'user');
            input.value = '';

            const loading = document.createElement('div');
            loading.textContent = 'Escribiendo...';
            loading.classList.add('message', 'ai-message');
            document.getElementById('messages-container').appendChild(loading);
            document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight;

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                loading.remove();
                addMessage(data.reply, 'ai', data.audio);
            } catch (e) {
                loading.remove();
                addMessage('Error al procesar tu solicitud.', 'ai');
                console.error('Error:', e);
            }
        }

        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('donate-button').addEventListener('click', async () => {
            let amount = document.getElementById('donation-amount').value;
            if (amount < 4.99) { alert("La donación mínima es $4.99 USD"); return; }
            const res = await fetch("/create-donation-session", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ amount: parseFloat(amount) }) });
            const data = await res.json();
            if (data.url) { window.open(data.url, '_blank'); } else { alert('Error: ' + data.error); }
        });

        document.getElementById('service-button').addEventListener('click', async () => {
            const res = await fetch("/create-service-session", { method: 'POST' });
            const data = await res.json();
            if (data.url) { window.open(data.url, '_blank'); } else { alert('Error: ' + data.error); }
        });
    </script>

</body>
</html>
