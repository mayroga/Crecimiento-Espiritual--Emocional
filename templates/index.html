<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente May Roga</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h1>Respira y Sonríe</h1>

    <!-- Chat -->
    <div>
        <input type="text" id="user-input" placeholder="Escribe tu mensaje...">
        <button onclick="sendMessage()">Enviar</button>
    </div>
    <div id="chat-box"></div>

    <!-- Donación -->
    <div>
        <input type="number" id="donation-amount" placeholder="Monto donación USD" min="0.5" step="0.01"/>
        <button id="donate-button">Aporta lo que quieras</button>
    </div>

    <!-- Servicio -->
    <div>
        <input type="number" id="service-amount" placeholder="Monto servicio USD" min="1" step="0.01"/>
        <button id="service-button">Paga tu servicio</button>
    </div>

    <script>
        const stripe = Stripe("{{ key }}");

        // Chat
        async function sendMessage() {
            const input = document.getElementById("user-input");
            const message = input.value;
            input.value = "";

            const res = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });
            const data = await res.json();

            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += `<p><b>Tú:</b> ${message}</p>`;
            chatBox.innerHTML += `<p><b>Asistente:</b> ${data.reply}</p>`;

            if (data.audio) {
                const audio = new Audio(data.audio);
                audio.play();
            }
        }

        // Donación
        document.getElementById('donate-button').addEventListener('click', async ()=>{
            let amount = parseFloat(document.getElementById('donation-amount').value);
            if(isNaN(amount) || amount < 0.5) amount = 0.5;
            const res = await fetch("/create-donation-session",{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({amount})
            });
            const session = await res.json();
            stripe.redirectToCheckout({sessionId: session.id});
        });

        // Servicio
        document.getElementById('service-button').addEventListener('click', async ()=>{
            let amount = parseFloat(document.getElementById('service-amount').value);
            if(isNaN(amount) || amount < 1) amount = 1;
            const res = await fetch("/create-service-session",{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({amount})
            });
            const session = await res.json();
            stripe.redirectToCheckout({sessionId: session.id});
        });
    </script>
</body>
</html>
