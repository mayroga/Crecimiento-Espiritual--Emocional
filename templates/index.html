<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crecimiento Espiritual-Emocional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .chat-container { max-width: 768px; height: 95vh; display: flex; flex-direction: column; margin: auto; }
        .message { padding: 1rem; border-radius: 1rem; margin-bottom: 0.5rem; max-width: 80%; word-wrap: break-word; }
        .user-message { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .ai-message { background-color: #ffffff; color: #374151; align-self: flex-start; border-bottom-left-radius: 0.25rem; position: relative; }
        .audio-icon { cursor: pointer; margin-left: 0.5rem; width: 1.25rem; height: 1.25rem; display: inline-block; }
        .payment-section { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center p-4 sm:p-6">

    <div class="chat-container bg-white shadow-xl rounded-2xl overflow-hidden flex flex-col w-full">
        <header class="bg-indigo-600 text-white p-4 text-center text-xl font-semibold rounded-t-2xl">
            Crecimiento Espiritual-Emocional
        </header>

        <div id="messages-container" class="flex-grow p-4 overflow-y-auto space-y-4"></div>

        <div class="p-4 bg-gray-100 flex items-center rounded-b-2xl">
            <input type="text" id="user-input" placeholder="Escribe tu mensaje..."
                   class="flex-grow p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200 shadow-sm">
            <button id="send-button"
                    class="ml-2 bg-indigo-600 text-white p-3 rounded-xl transition-all duration-200 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.917H17.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.917a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </div>
        
        <div class="p-4 bg-gray-100 rounded-b-2xl payment-section">
            <div class="flex items-center w-full max-w-sm">
                <input type="number" id="donation-amount" placeholder="Monto donación USD" min="4.99" step="0.01" class="border p-2 rounded-xl flex-grow mr-2">
                <button id="donate-button" class="bg-green-500 text-white p-2 rounded-xl hover:bg-green-600 transition">Aporta lo que quieras</button>
            </div>
            <div class="flex items-center w-full max-w-sm">
                <button id="service-button" class="bg-blue-500 text-white p-2 rounded-xl hover:bg-blue-600 transition w-full">Paga tu servicio ($10.00)</button>
            </div>
        </div>

    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe("{{ stripe_pub_key }}");

        function addMessage(text, sender, audioData = null) {
            const messagesContainer = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            if (audioData) {
                const audio = new Audio(`data:audio/mp3;base64,${audioData}`);
                const audioIcon = document.createElement('span');
                audioIcon.classList.add('audio-icon');
                audioIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block text-gray-500 ml-2">
                                            <path d="M13.5 4.5a1.5 1.5 0 0 0-1.5 1.5V18a1.5 1.5 0 0 0 3 0V6a1.5 1.5 0 0 0-1.5-1.5ZM6 4.5a1.5 1.5 0 0 0-1.5 1.5V18a1.5 1.5 0 0 0 3 0V6a1.5 1.5 0 0 0-1.5-1.5Z" />
                                        </svg>`;
                messageDiv.appendChild(audioIcon);
                audioIcon.addEventListener('click', () => audio.play());
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const msg = input.value.trim();
            if (msg === '') return;

            addMessage(msg, 'user');
            input.value = '';

            const loading = document.createElement('div');
            loading.textContent = 'Escribiendo...';
            loading.classList.add('message', 'ai-message');
            document.getElementById('messages-container').appendChild(loading);
            document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight;

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                loading.remove();
                addMessage(data.reply, 'ai', data.audio);
            } catch (e) {
                loading.remove();
                addMessage('Error al procesar tu solicitud.', 'ai');
                console.error('Error:', e);
            }
        }

        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        // Manejador del botón de donación
        document.getElementById('donate-button').addEventListener('click', async () => {
            let amount = document.getElementById('donation-amount').value;
            if (amount < 4.99) {
                alert("La donación mínima es $4.99 USD");
                return;
            }
            const res = await fetch("/create-donation-session", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: parseFloat(amount) })
            });
            const data = await res.json();
            if (data.url) {
                window.location.href = data.url;
            } else {
                alert('Error al crear la sesión de donación: ' + data.error);
            }
        });

        // Manejador del botón de servicio (nuevo)
        document.getElementById('service-button').addEventListener('click', async () => {
            const res = await fetch("/create-service-session", {
                method: 'POST'
            });
            const data = await res.json();
            if (data.url) {
                window.location.href = data.url;
            } else {
                alert('Error al crear la sesión de pago de servicio: ' + data.error);
            }
        });
    </script>
</body>
</html>
